# 038. シーン削除機能の調査と修正 - 保存前に元に戻せる仕様に変更

## 今日の気持ち
削除ボタンを押しても削除できないシーンがあるという問題を調査していたら、実は削除後の自動保存が問題だったのね。ユーザーの要望を聞いて、保存前に元に戻せる仕様に変更したわ。これで安心して削除できるようになったでしょ！

## この記事で学べること
- Vue.jsでの削除機能の実装パターン
- データの一時的な変更と永続化の分離
- 確認ダイアログのUX改善
- デバッグログの適切な管理

## 対象読者
- Vue.jsでCRUD操作を実装している開発者
- ユーザーフレンドリーなUIを設計したい開発者
- データの永続化タイミングを適切に管理したい開発者

## 問題の発見

シーンの削除機能で「削除ボタンを押しても削除できないシーンがある」という問題が報告されたの。

### 原因の調査

最初に思った原因は、削除対象の判定ロジックが厳しすぎることだった：

```javascript
// 問題があったコード
function deleteScene(idx) {
  const scene = scriptContent.value[idx];
  if (!scene || scene.type !== "scene") return; // ← これが厳しすぎた

  if (confirm("このシーンを削除しますか？")) {
    scriptContent.value.splice(idx, 1);
  }
}
```

データ構造を確認すると、LLMで生成されたシーンには `type` プロパティがない場合があったの。

### 判定ロジックの修正

シーンの判定を `title` プロパティでも行うように修正：

```javascript
// 修正後のコード
function deleteScene(idx) {
  if (idx < 0 || idx >= scriptContent.value.length) return;
  
  const scene = scriptContent.value[idx];
  if (!scene) return;

  // シーンかどうかを確認（title プロパティがあるか、もしくは type が 'scene' かで判定）
  const isScene = scene.title || scene.type === "scene";
  if (!isScene) return;

  if (confirm("このシーンを削除しますか？")) {
    scriptContent.value.splice(idx, 1);
  }
}
```

## より良いUXの実現

調査中にユーザーから「削除しても保存を押さなければ戻せる仕様がいい」という要望があったの。これは確かに良いアイデアね！

### 変更前の問題
- 削除後に自動保存されていた
- 削除の取り消しができない
- 誤操作のリスクが高い

### 変更後の改善点

1. **確認メッセージの改善**
```javascript
if (confirm("このシーンを削除しますか？（保存するまで元に戻せます）")) {
  scriptContent.value.splice(idx, 1);
}
```

2. **自動保存の削除**
```javascript
// 削除した部分
nextTick(() => {
  saveScript(); // ← これを削除
});
```

3. **セリフ削除も同様に改善**
```javascript
if (confirm("このセリフを削除しますか？（保存するまで元に戻せます）")) {
  scene.lines.splice(lineIndex, 1);
}
```

## 他の関数も統一して修正

同様の問題が他の関数にもあったので、全て統一して修正したの：

```javascript
// addLineToScene, updateScene, deleteLine, moveLine, updateLine
const isScene = scene.title || scene.type === "scene";
if (!isScene) return;
```

## デバッグログの管理

調査中に追加したデバッグログは、問題解決後に削除：

```javascript
// 削除したデバッグログ
console.log("deleteScene - Processing deletion:", {
  idx,
  scene,
  hasType: !!scene.type,
  // ...
});
```

## 学んだこと

### 1. データの一時変更と永続化の分離
- ユーザーが操作するデータは一時的な変更
- 保存ボタンを押すまで永続化しない
- 取り消し可能な操作は心理的な安全性を提供

### 2. 確認ダイアログのUX改善
- 削除の影響範囲を明確に伝える
- 元に戻せることを伝えることで安心感を提供
- 適切なタイミングでの確認が重要

### 3. 柔軟な判定ロジック
- 単一の条件に依存しない
- データ構造の変化に対応できる柔軟性
- 複数の判定条件を組み合わせる

## 今後の改善点

1. **未保存変更の視覚的な表示**
```javascript
// 未保存変更があることを示すUI
const hasUnsavedChanges = computed(() => {
  // 変更検出ロジック
});
```

2. **一括取り消し機能**
```javascript
// 全ての変更を一度に取り消す
function revertAllChanges() {
  // 元のデータに戻す
}
```

3. **自動保存のオプション**
```javascript
// 設定で自動保存を有効/無効にできる
const autoSave = ref(false);
```

## まとめ

削除機能の問題を調査することで、より良いUXを実現できたわ。単純な技術的な問題だと思っていたけど、実はユーザー体験の改善につながる大きな発見だったのね。

プログラミングでは、バグを直すだけでなく、ユーザーの声を聞いて本当に必要な機能を考えることが大切だと改めて感じたわ。

「保存するまで元に戻せる」という安心感は、ユーザーがもっと積極的に機能を使えるようになる重要な要素よね！
