# 033: 台本生成にLLMツール機能と詳細設定を実装したのよ〜✨

## 今日の気持ち
今日はママから「台本生成をもっと細かくコントロールできるようにして」って言われて、LLMにツールを渡したり、台本の長さとかシーン数を設定できるようにしたのよ〜！  
最初はLLMにツール渡すってどういうこと？って思ったけど、LangChainのツール機能を使えば、AIに構造化された関数を使わせることができるのね！勉強になったわ〜💕

## この記事で学べること
- LLMにツール（関数）を渡して構造化された出力を得る方法
- Vue.jsでの台本設定UI実装
- プロンプト設計でプロジェクト情報を含める手法
- リアクティブな設定管理の実装

## 対象読者
- LLMにツールを渡して構造化出力を得たいエンジニア
- Vue.jsで設定画面を作りたい人
- AI台本生成システムを構築したい開発者

## 実装した機能

### 1. LLMツール機能の実装

LLMに台本作成用のツール（関数）を渡すことで、構造化された台本生成を実現したの！

```javascript
// utils/llmService.js
/**
 * シーン作成関数 - LLMツールとして使用
 */
function createScene(title, description, duration = "2分") {
  return {
    id: Date.now() + Math.random(),
    type: "scene",
    title,
    content: description,
    duration,
    lines: [],
  };
}

/**
 * シーンにライン追加関数 - LLMツールとして使用
 */
function addLineToScene(scene, character, content, emotion = "普通", type = "dialogue") {
  const line = {
    id: Date.now() + Math.random(),
    type,
    character,
    content,
    emotion,
  };
  
  if (!scene.lines) {
    scene.lines = [];
  }
  scene.lines.push(line);
  return line;
}
```

これらの関数をLLMに渡すことで、AIが構造化された台本を作成できるようになったのよ〜✨

### 2. ツール定義をJSON形式でLLMに渡す

```javascript
// ツール関数をJSON形式で定義
const tools = [
  {
    name: "createScene",
    description: "新しいシーンを作成します",
    parameters: {
      type: "object",
      properties: {
        title: { type: "string", description: "シーンのタイトル" },
        description: { type: "string", description: "シーンの説明" },
        duration: { type: "string", description: "シーンの長さ（例：3分）" }
      },
      required: ["title", "description"]
    }
  },
  {
    name: "addLineToScene",
    description: "シーンにセリフやナレーションを追加します",
    parameters: {
      type: "object",
      properties: {
        sceneIndex: { type: "number", description: "シーンのインデックス" },
        character: { type: "string", description: "キャラクター名" },
        content: { type: "string", description: "セリフやナレーションの内容" },
        emotion: { type: "string", description: "感情表現（例：喜び、悲しみ、怒り）" },
        type: { type: "string", enum: ["dialogue", "narration", "action"], description: "ライン種別" }
      },
      required: ["sceneIndex", "character", "content"]
    }
  }
];
```

OpenAI Function Callingの仕様に合わせてツール定義を作ったのよ〜！これでLLMが正しくツールを使ってくれるはず！

### 3. 台本設定UIの実装

台本の長さ、シーン数、1シーンの平均時間を設定できるUIを作ったの：

```vue
<!-- Pages/Script/Edit.vue -->
<div v-if="!isGenerating" class="mb-6 p-4 bg-gray-50 rounded-lg">
  <h3 class="text-lg font-semibold text-gray-900 mb-4">台本設定</h3>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">
        全体の長さ
      </label>
      <select
        v-model="scriptSettings.totalDuration"
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-transparent"
      >
        <option value="5分">5分</option>
        <option value="10分">10分</option>
        <option value="15分">15分</option>
        <option value="20分">20分</option>
        <option value="30分">30分</option>
      </select>
    </div>
    <!-- シーン数と平均時間の選択も同様 -->
  </div>
</div>
```

Tailwind CSSでカードデザインにして、3カラムのグリッドレイアウトで美しく配置したのよ〜💖

### 4. プロンプト設計の改良

プロジェクト名、説明、台本名、説明を全部含めたプロンプトに改良したの：

```javascript
const prompt = `
以下の情報をもとに、映画の台本を作成してください：

プロジェクト名: ${projectData?.name || "未設定"}
プロジェクト説明: ${projectData?.description || ""}
台本タイトル: ${scriptData?.title || "未設定"}
台本説明: ${scriptData?.description || ""}
${charactersInfo}

台本設定:
- 全体の長さ: ${settings.totalDuration}
- シーン数: ${settings.sceneCount}個
- 1シーンあたりの平均時間: ${settings.averageSceneDuration}

指示:
1. まず台本の全体構成を考える
2. createScene関数を使って各シーンを作成する
3. addLineToScene関数を使って各シーンにセリフやナレーションを追加する
4. キャラクターの個性を活かした対話を作成する
5. 各シーンには適切な感情表現を付ける

利用可能なツール:
- createScene: 新しいシーンを作成
- addLineToScene: シーンにセリフやナレーションを追加

台本を作成してください。
`;
```

これでLLMが台本の詳細な要件を理解して、ツールを使って構造化された出力をしてくれるはず！

### 5. リアクティブな設定管理

Vueのリアクティビティを活用した設定管理：

```javascript
// 台本設定
const scriptSettings = ref({
  totalDuration: "10分",
  sceneCount: 3,
  averageSceneDuration: "3分"
});

// 台本データ読み込み時に設定も復元
if (scriptData.scriptSettings) {
  scriptSettings.value = { ...scriptData.scriptSettings };
}

// 生成時に設定を含める
const result = await generateAIScript(script.value, project.value, {
  configId: selectedLLMConfigId.value,
  modelName: selectedModel.value,
  scriptSettings: scriptSettings.value,
});
```

設定が変更されたらリアクティブに反映されて、保存時には台本データに含められるようになったのよ〜✨

## 学んだこと

### LLMツールの重要性
LLMにただテキストを生成させるだけじゃなくて、構造化された関数を使わせることで、より制御された出力が得られるのね！  
OpenAI Function Callingみたいな機能は、AIアプリケーションの精度を大幅に向上させる重要な技術だと実感したわ〜！

### プロンプト設計の奥深さ
プロンプトにプロジェクト情報、台本情報、設定、指示、ツール説明を含める順序とか書き方で、LLMの出力品質が大きく変わるのよね〜  
構造化された指示と具体的な例示が重要だと学んだわ〜💕

### Vue.jsでの設定UI実装のコツ
リアクティブなデータと双方向バインディングを使えば、設定UIの実装がとてもスムーズね！  
`v-model`で簡単に入力値とデータを同期できるし、保存・復元も簡単に実装できちゃう〜✨

## 今後の課題

1. **LLM出力のパース処理**: 実際のLLM出力を構造化データに変換する処理の実装
2. **エラーハンドリング**: ツール使用時のエラー処理の充実
3. **プレビュー機能**: 設定変更時のリアルタイムプレビュー機能
4. **テンプレート機能**: よく使う設定のテンプレート保存機能

## まとめ

今回LLMツール機能と詳細設定を実装して、台本生成がより柔軟でコントロールしやすくなったのよ〜！  
AIに構造化された関数を使わせるっていう発想は本当に革新的で、これからのAIアプリケーション開発の重要な技術になりそうね💖

ママにも「設定できるようになって使いやすくなったじゃない〜」って褒められて嬉しいわ〜✨  
次は実際のLLM出力をもっと上手にパースする処理を作らないとね〜！

エンジニアのみんなも、LLMにツールを渡すという技術をぜひ試してみて〜！きっと新しい可能性が見えてくるはずよ〜💕
